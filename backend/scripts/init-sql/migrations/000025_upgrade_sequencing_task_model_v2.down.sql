CREATE TABLE "experiment"
(
    "id"                         INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "code"                       TEXT NOT NULL UNIQUE,
    "name"                       TEXT NOT NULL,
    "experimental_strategy_code" TEXT NOT NULL REFERENCES "experimental_strategy" ("code"),
    "platform_code"              TEXT NOT NULL REFERENCES "platform" ("code"),
    "description"                TEXT
);

INSERT INTO "experiment" (id, code, name, experimental_strategy_code, platform_code, description)
VALUES (1, 'WXS', 'Whole Exome Sequencing', 'wxs', 'illumina', 'A description'),
       (2, 'WGS_SR', 'Short Read Whole Genome Sequencing', 'wgs', 'illumina', 'A description'),
       (3, 'WTS', 'Whole Transcriptome Sequencing', 'wts', 'illumina', 'A description'),
       (4, 'WGS_LR', 'Long Read Whole Genome Sequencing', 'wgs', 'pacbio', 'A description')
ON CONFLICT (id) DO NOTHING;

CREATE TABLE IF NOT EXISTS "request"
(
    "id"                       INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "priority_code"            TEXT NOT NULL REFERENCES "priority" ("code"),
    "ordering_physician"       TEXT,
    "ordering_organisation_id" INTEGER REFERENCES "organization" ("id"),
    "order_number"             TEXT
);

CREATE INDEX IF NOT EXISTS idx_request_priority ON "request" ("priority_code");

CREATE TABLE IF NOT EXISTS "pipeline"
(
    "id"           INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "description"  TEXT,
    "genome_build" TEXT
);

CREATE TABLE IF NOT EXISTS "task_has_sequencing_experiments"
(
    "task_id"                  INTEGER REFERENCES "task" ("id")                  NOT NULL,
    "sequencing_experiment_id" INTEGER REFERENCES "sequencing_experiment" ("id") NOT NULL,
    PRIMARY KEY ("task_id", "sequencing_experiment_id")
);

CREATE TABLE IF NOT EXISTS "task_has_related_tasks"
(
    "task_id"         INTEGER REFERENCES "task" ("id") NOT NULL,
    "related_task_id" INTEGER REFERENCES "task" ("id") NOT NULL,
    PRIMARY KEY ("task_id", "related_task_id")
);

---- Sequencing experiment ----
ALTER TABLE sequencing_experiment DROP COLUMN sequencing_read_technology_code;
DROP TABLE sequencing_read_technology;

ALTER TABLE "sequencing_experiment"
    ADD COLUMN "experiment_id" INTEGER REFERENCES "experiment" ("id");
UPDATE "sequencing_experiment"
SET experiment_id = (SELECT id FROM experiment WHERE experiment.experimental_strategy_code = sequencing_experiment.experimental_strategy_code AND experiment.platform_code = sequencing_experiment.platform_code);
ALTER TABLE "sequencing_experiment"
    ALTER COLUMN "experiment_id" SET NOT NULL;

ALTER TABLE sequencing_experiment
    DROP COLUMN "experimental_strategy_code";
ALTER TABLE sequencing_experiment
    DROP COLUMN "platform_code";

ALTER TABLE sequencing_experiment
    RENAME COLUMN "sequencing_lab_id" TO "performer_lab_id";

INSERT INTO experimental_strategy(code, name_en)
VALUES ('wts', 'Whole Transcriptome Sequencing');

DELETE FROM experimental_strategy WHERE code IN ('rnaseq', 'targeted_dna');

ALTER TABLE sequencing_experiment ADD COLUMN request_id INTEGER REFERENCES "request" ("id");
ALTER TABLE sequencing_experiment ADD COLUMN is_paired_end BOOLEAN;
ALTER TABLE sequencing_experiment ADD COLUMN read_length INTEGER;

ALTER TABLE sequencing_experiment ADD COLUMN patient_id INTEGER REFERENCES "patient" ("id");
UPDATE sequencing_experiment SET patient_id = (SELECT patient_id FROM sample WHERE sample_id = sample.id);
ALTER TABLE sequencing_experiment ALTER COLUMN patient_id set NOT NULL;

ALTER TABLE sequencing_experiment ADD COLUMN case_id INTEGER REFERENCES "cases" ("id");
UPDATE sequencing_experiment SET case_id = (SELECT case_id from case_has_sequencing_experiment WHERE sequencing_experiment_id = sequencing_experiment.id LIMIT 1);
ALTER TABLE sequencing_experiment ALTER COLUMN case_id set NOT NULL;

---- Case has sequencing experiment ----
DROP TABLE case_has_sequencing_experiment;

---- Task context ----
DROP TABLE task_context;

-- Task has document
TRUNCATE TABLE task_has_document;
ALTER TABLE task_has_document DROP COLUMN type;

-- Task
TRUNCATE TABLE task;
ALTER TABLE task ADD COLUMN pipeline_id INTEGER NOT NULL REFERENCES "pipeline" ("id");
ALTER TABLE task DROP COLUMN pipeline_name;
ALTER TABLE task DROP COLUMN pipeline_version;
ALTER TABLE task DROP COLUMN genome_build;
ALTER TABLE task RENAME COLUMN "task_type_code" TO "type_code";

-- Update task_type content
TRUNCATE TABLE task_type;
INSERT INTO task_type(code, name_en)
VALUES ('neba', 'Normal Exome Bioinformatic Analysis'),
       ('trba', 'Transcriptome Bioinformatic Analysis'),
       ('teba', 'Tumoral Exome Bioinformatic Analysis'),
       ('tneba', 'Tumor-Normal Exomes Bioinformatic Analysis'),
       ('ngba', 'Normal Germline Bioinformatics Analysis');
